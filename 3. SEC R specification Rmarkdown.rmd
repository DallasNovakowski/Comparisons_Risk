---
title: "SEC R specification Rmarkdown"
output: html_document
---

library(lavaan)

load(file="C:/Users/dalla/Google Drive/R Coding/Comparisons_Risk/SEC_R_Crowd_2_22_2019_imputed.Rdata")

VarBase$R <- c('SOEPg', 'SOEPdri', 'SOEPocc', 'SOEPfin', 'SOEPrec', 'SOEPhea', 'SOEPsoc', 'SSexp', 'SSdis', 'SSas', 'SSbor', 'BISa', 'BISm', 'BISn', 'Dhea', 'Dinv', 'Dgam', 'Deth', 'Drec', 'Dsoc', 'Dm', 'GBS', 'DAST_dich', 'FTND_dich', 'AUDIT', 'NODS_dich')

summary(tib_summed[,c(VarBase$R)])

#SECmodel
SECmodel <- '
fSEC =~ fSECenvy + fSECcse + fSECjs
fSECenvy =~ SEC_1 + SEC_2 + SEC_3 + SEC_4
fSECcse =~ SEC_5 + SEC_6 + SEC_7 + SEC_8
fSECjs =~ SEC_9 + SEC_10 + SEC_11 + SEC_12
'

fit.SEC.hierar <- cfa(SECmodel, data=residuals_std2, std.lv = TRUE)
summary(fit.SEC.hierar, fit.measures=TRUE)
parameterEstimates(fit.SEC.hierar)

#Rmodel, replacing "-" with "+"
Rmodel <- '
fR =~ SOEPg + SOEPdri + SOEPocc + SOEPfin + SOEPrec + SOEPhea + SOEPsoc + Dhea + Dinv + Dgam + Deth + Drec + Dsoc + SSas + SSexp + SSdis + SSbor + BISa + BISm + BISn + AUDIT + FTND_dich + DAST_dich + NODS_dich + Dm

f1 =~ Dhea + SSdis + FTND_dich + Dm + SOEPg + SOEPrec + SOEPocc
f2 =~ SOEPfin + Dinv + Dgam + Deth + SSexp + FTND_dich
f3 =~ SOEPrec + Drec + SSas
f4 =~ BISa + BISm + BISn
f5 =~ SOEPdri + SOEPfin + NODS_dich + Deth + Dsoc + SSexp
'


# Fit Rmodel, constraining covariances of all latent variables to be orthogonal
fit.R.ortho <- cfa(Rmodel, data=residuals_std2, std.lv = TRUE, orthogonal=TRUE)
# display summary output
summary(fit.R.ortho, fit.measures=TRUE)
parameterEstimates(fit.R.ortho)

# the specified Rmodel doesn't fit the data well: TLI = .702 (threshold >= .95), CFI = .752 (threshold >= .90), SRMR = .084 (threshold <.08), RMSEA = .092 (threhold < .08); also can't compute standard errors (SOEPfin has a variance estimate of -439.508); model might be underidentified

#time for exploratory analyses for the measurement model
library(parallel)
library(nFactors)
library(polycor)

SEC_corr <- cor(residuals_std2[,c(VarBase$SECtot)])
R_corr <- cor(residuals_std2[,c(VarBase$R)])
all_corr <- cor(residuals_std2[,c(VarBase$Spec)], use = "complete.obs")
  
#analyses for eigen values and parallel analysis
ev <- eigen(R_corr)  
ap <- nFactors::parallel(subject=804, var=nrow(R_corr), rep=100, cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)

#print results of parallel analysis
print(nS)
nS$Components$nparallel

#parallel analysis indicates 5 factors
nfact <- nS$Components$nparallel

#bifactor model
m_bif <-  fa(r=R_corr, covar=F, n.obs=804, nfactors=nfact+1, rotate="bifactor", fm="ml")
print(m_bif)

print(m_bif$loadings, digits=2, cutoff=.29, sort=T)


m1 <- fa(r=R_corr, covar=F, n.obs=804, nfactors=nfact, rotate="varimax", fm="minres")
print(m1$loadings, digits=2, cutoff=.29, sort=T)
m2 <- fa(r=R_corr, covar=F, n.obs=804, nfactors=nfact, rotate="promax", fm="minres")
print(m2$loadings, digits=2, cutoff=.29, sort=T)
m3 <- fa(r=R_corr, covar=F, n.obs=804, nfactors=nfact, rotate="oblimin", fm="minres")
print(m3$loadings, digits=2, cutoff=.29, sort=T)

m4 <- schmid(R_corr, nfactors=nfact, n.obs=804, rotate="promax")
print(m4$loadings, digits=2, cutoff=.29, sort=T)

FullModel <- '

#path
fR ~ fSEC

#SECmodel
fSEC =~ fSECenvy + fSECcse + fSECjs
fSECenvy =~ SEC_1 + SEC_2 + SEC_3 + SEC_4
fSECcse =~ SEC_5 + SEC_6 + SEC_7 + SEC_8
fSECjs =~ SEC_9 + SEC_10 + SEC_11 + SEC_12

#Rmodel
fR =~ SOEPg + SOEPdri + SOEPocc + SOEPfin + SOEPrec + SOEPhea + SOEPsoc + Dhea + Dinv + Dgam + Deth + Drec + Dsoc + SSas + SSexp + SSdis + SSbor + BISa + BISm + BISn + AUDIT + FTND + DAST + NODS + Dm

f1 =~ Dhea + SSdis + FTND + Dm - SOEPg - SOEPrec - SOEPocc
f2 =~ SOEPfin + Dinv + Dgam + Deth - SSexp
f3 =~ SOEPrec + Drec + SSas
f4 =~ BISa + BISm + BISn
f5 =~ SOEPdri + SOEPfin + NODS - Deth - Dsoc - SSexp
'

